{% extends "base.html" %} {% block title %}Dashboard - Green Corridor System{%
endblock %} {% block extra_css %}
<style>
  .video-container {
    position: relative;
    background: #000;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    min-height: 400px;
  }

  .video-feed {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 15px;
  }

  .detection-overlay {
    position: absolute;
    top: 15px;
    left: 15px;
    background: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 15px;
    border-radius: 10px;
    font-size: 0.9rem;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .emergency-overlay {
    position: absolute;
    top: 15px;
    right: 15px;
    background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
    color: white;
    padding: 15px;
    border-radius: 10px;
    font-weight: bold;
    animation: emergencyPulse 1s infinite alternate;
    display: none;
  }

  @keyframes emergencyPulse {
    from {
      box-shadow: 0 0 20px rgba(255, 65, 108, 0.5);
    }
    to {
      box-shadow: 0 0 40px rgba(255, 65, 108, 0.8);
    }
  }

  .detection-stats {
    position: absolute;
    bottom: 15px;
    left: 15px;
    right: 15px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
  }

  .confidence-bar {
    width: 100%;
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 5px;
  }

  .confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    transition: width 0.3s ease;
  }

  .signal-status {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: 10px;
    margin: 8px 0;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .signal-status::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.2),
      transparent
    );
    transition: left 0.5s;
  }

  .signal-status:hover::before {
    left: 100%;
  }

  .signal-green {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    animation: pulseGreen 1.5s infinite;
  }

  @keyframes pulseGreen {
    0%,
    100% {
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }
    50% {
      box-shadow: 0 4px 25px rgba(40, 167, 69, 0.6);
    }
  }

  .signal-red {
    background: linear-gradient(135deg, #dc3545, #e74c3c);
    color: white;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
  }

  .signal-yellow {
    background: linear-gradient(135deg, #ffc107, #f39c12);
    color: black;
    box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
  }

  .stats-card {
    border-left: 4px solid;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .stats-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.1),
      transparent
    );
    transition: left 0.8s;
  }

  .stats-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  }

  .stats-card:hover::before {
    left: 100%;
  }

  .stats-card.primary {
    border-left-color: #667eea;
  }
  .stats-card.success {
    border-left-color: #28a745;
  }
  .stats-card.warning {
    border-left-color: #ffc107;
  }
  .stats-card.danger {
    border-left-color: #dc3545;
  }

  .live-detection-item {
    background: rgba(40, 167, 69, 0.1);
    border-left: 4px solid #28a745;
    padding: 12px;
    margin: 8px 0;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .live-detection-item.ambulance {
    background: rgba(220, 53, 69, 0.1);
    border-left-color: #dc3545;
    animation: emergencyBlink 2s infinite;
  }

  @keyframes emergencyBlink {
    0%,
    50% {
      background: rgba(220, 53, 69, 0.1);
    }
    25%,
    75% {
      background: rgba(220, 53, 69, 0.2);
    }
  }

  .detection-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .badge-ambulance {
    background: linear-gradient(135deg, #ff416c, #ff4b2b);
    color: white;
  }

  .badge-vehicle {
    background: linear-gradient(135deg, #4facfe, #00f2fe);
    color: white;
  }

  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
  }

  .status-active {
    background: #28a745;
    box-shadow: 0 0 10px #28a745;
    animation: pulse 2s infinite;
  }

  .status-inactive {
    background: #6c757d;
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 0 10px #28a745;
    }
    50% {
      box-shadow: 0 0 20px #28a745, 0 0 30px #28a745;
    }
    100% {
      box-shadow: 0 0 10px #28a745;
    }
  }

  .camera-controls {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 20px;
    color: white;
  }

  .realtime-chart {
    height: 200px;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
  }

  .detection-history {
    max-height: 400px;
    overflow-y: auto;
  }

  .detection-history::-webkit-scrollbar {
    width: 6px;
  }

  .detection-history::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }

  .detection-history::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
  }

  .detection-history::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="text-center mb-4" data-aos="fade-down">
        <h1 class="display-4 fw-bold text-white mb-3">
          <i class="fas fa-tachometer-alt me-3"></i>Live AI Dashboard
        </h1>
        <p class="lead text-white-50">
          Real-time YOLOv8 detection with live bounding boxes and emergency
          response
        </p>
      </div>
    </div>
  </div>

  <!-- Enhanced Control Panel -->
  <div class="row mb-4">
    <div class="col-12" data-aos="fade-up">
      <div class="camera-controls">
        <div class="d-flex gap-3 align-items-center flex-wrap">
          <button class="btn btn-success btn-lg" id="startCameraBtn">
            <i class="fas fa-play me-2"></i>Start Live Detection
          </button>
          <button class="btn btn-danger btn-lg" id="stopCameraBtn" disabled>
            <i class="fas fa-stop me-2"></i>Stop Detection
          </button>
          <div class="ms-auto d-flex align-items-center gap-3">
            <div>
              <span class="badge bg-light text-dark" id="cameraStatus"
                >Camera Off</span
              >
              <span class="badge bg-info" id="modelStatus">YOLOv8 Ready</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Dashboard Content -->
  <div class="row">
    <!-- Enhanced Live Feed Section -->
    <div class="col-lg-8">
      <div class="card mb-4" data-aos="fade-right">
        <div class="card-header bg-success text-white">
          <h4 class="mb-0">
            <i class="fas fa-eye me-2"></i>Live YOLOv8 Detection Feed
          </h4>
          <small>Real-time object detection with bounding boxes</small>
        </div>
        <div class="card-body p-0">
          <div class="video-container" id="videoContainer">
            <!-- Video feed with bounding boxes -->
            <img
              id="videoFeedImg"
              class="video-feed"
              style="display: none"
              alt="Live video feed with detections"
            />

            <div
              class="d-flex align-items-center justify-content-center"
              style="
                height: 400px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              "
              id="cameraPlaceholder"
            >
              <div class="text-center text-white">
                <i class="fas fa-video fa-5x mb-4"></i>
                <h4>AI Detection Ready</h4>
                <p class="mb-3">
                  Click "Start Live Detection" to begin real-time analysis
                </p>
                <div class="row text-center">
                  <div class="col-4">
                    <i class="fas fa-brain fa-2x mb-2"></i>
                    <p><small>YOLOv8 AI</small></p>
                  </div>
                  <div class="col-4">
                    <i class="fas fa-crosshairs fa-2x mb-2"></i>
                    <p><small>Live Tracking</small></p>
                  </div>
                  <div class="col-4">
                    <i class="fas fa-ambulance fa-2x mb-2"></i>
                    <p><small>Emergency Alert</small></p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enhanced Detection Overlays -->
            <div
              class="detection-overlay"
              id="detectionOverlay"
              style="display: none"
            >
              <div><strong>Live Detection Status</strong></div>
              <div id="detectionInfo">Initializing...</div>
              <div class="confidence-bar">
                <div class="confidence-fill" id="confidenceBar"></div>
              </div>
            </div>

            <div class="emergency-overlay" id="emergencyOverlay">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>EMERGENCY VEHICLE DETECTED!</strong>
              <div><small>Activating Green Corridor...</small></div>
            </div>

            <div
              class="detection-stats"
              id="detectionStats"
              style="display: none"
            >
              <div>Objects: <span id="objectCount">0</span></div>
              <div>Confidence: <span id="avgConfidence">0%</span></div>
              <div>Processing: <span id="processingTime">0ms</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced Traffic Map -->
      <div class="card" data-aos="fade-right" data-aos-delay="200">
        <div class="card-header bg-info text-white">
          <h4 class="mb-0">
            <i class="fas fa-map-marked-alt me-2"></i>Smart Traffic Control
            System
          </h4>
          <small>Real-time signal management and emergency routing</small>
        </div>
        <div class="card-body">
          <div
            id="trafficMap"
            style="
              height: 350px;
              background: #f8f9fa;
              border-radius: 10px;
              position: relative;
            "
          >
            <div class="d-flex align-items-center justify-content-center h-100">
              <div class="text-center w-100">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <div class="signal-status signal-red" id="junction-a">
                      <i class="fas fa-traffic-light fa-2x me-3"></i>
                      <div>
                        <strong>Junction A</strong>
                        <div><small>Main St & 1st Ave</small></div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <div class="signal-status signal-red" id="junction-b">
                      <i class="fas fa-traffic-light fa-2x me-3"></i>
                      <div>
                        <strong>Junction B</strong>
                        <div><small>2nd St & Broadway</small></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Statistics and Controls -->
    <div class="col-lg-4">
      <!-- Real-time Emergency Status -->
      <div class="card mb-4" data-aos="fade-left">
        <div class="card-header bg-warning text-dark">
          <h4 class="mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>Emergency Control
            Center
          </h4>
        </div>
        <div class="card-body" id="emergencyStatus">
          <div class="text-center mb-3">
            <div class="mb-3">
              <div
                class="status-indicator status-inactive"
                id="emergencyIndicator"
              ></div>
              <span class="fw-bold fs-5" id="emergencyText"
                >System Monitoring</span
              >
            </div>
            <div class="row text-center">
              <div class="col-6">
                <div class="h3 mb-0" id="activeSignals">0</div>
                <small class="text-muted">Active Signals</small>
              </div>
              <div class="col-6">
                <div class="h3 mb-0" id="corridorStatus">Standby</div>
                <small class="text-muted">Green Corridor</small>
              </div>
            </div>
          </div>

          <!-- Real-time Chart -->
          <div class="realtime-chart" id="realtimeChart">
            <canvas id="detectionChart" width="100%" height="150"></canvas>
          </div>
        </div>
      </div>

      <!-- Enhanced Statistics -->
      <div class="row mb-4">
        <div class="col-12 mb-3" data-aos="fade-left" data-aos-delay="100">
          <div class="card stats-card primary">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i class="fas fa-eye fa-3x text-primary"></i>
                </div>
                <div>
                  <h6 class="card-title mb-0">Live Detections</h6>
                  <h3 class="mb-0" id="totalDetections">0</h3>
                  <small class="text-muted"
                    >Objects detected this session</small
                  >
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 mb-3" data-aos="fade-left" data-aos-delay="200">
          <div class="card stats-card success">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i class="fas fa-ambulance fa-3x text-success"></i>
                </div>
                <div>
                  <h6 class="card-title mb-0">Emergency Vehicles</h6>
                  <h3 class="mb-0" id="ambulanceCount">0</h3>
                  <small class="text-muted">Ambulances detected</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 mb-3" data-aos="fade-left" data-aos-delay="300">
          <div class="card stats-card warning">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i class="fas fa-tachometer-alt fa-3x text-warning"></i>
                </div>
                <div>
                  <h6 class="card-title mb-0">Response Time</h6>
                  <h3 class="mb-0" id="responseTime">0ms</h3>
                  <small class="text-muted">Average processing</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 mb-3" data-aos="fade-left" data-aos-delay="400">
          <div class="card stats-card danger">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i class="fas fa-crosshairs fa-3x text-danger"></i>
                </div>
                <div>
                  <h6 class="card-title mb-0">Detection Accuracy</h6>
                  <h3 class="mb-0" id="accuracyRate">98.5%</h3>
                  <small class="text-muted">YOLOv8 confidence</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced Recent Detections -->
      <div class="card" data-aos="fade-left" data-aos-delay="500">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">
            <i class="fas fa-history me-2"></i>Live Detection Stream
          </h5>
        </div>
        <div class="card-body">
          <div class="detection-history" id="recentDetections">
            <div class="text-center text-muted py-4">
              <i class="fas fa-brain fa-4x mb-3"></i>
              <h5>AI Detection Ready</h5>
              <p>Start camera to see live detections</p>
              <small class="text-muted">YOLOv8 model loaded and ready</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced System Information -->
  <div class="row mt-4">
    <div class="col-12" data-aos="fade-up">
      <div class="card">
        <div class="card-header bg-dark text-white">
          <h4 class="mb-0">
            <i class="fas fa-microchip me-2"></i>AI System Information
          </h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-2">
              <strong>AI Model:</strong><br />
              <span class="text-muted">YOLOv8n (best.pt)</span><br />
              <small class="text-success">Loaded âœ“</small>
            </div>
            <div class="col-md-2">
              <strong>Confidence:</strong><br />
              <span class="text-muted">40% threshold</span><br />
              <small class="text-info">Optimized</small>
            </div>
            <div class="col-md-2">
              <strong>Processing:</strong><br />
              <span class="text-muted">Real-time inference</span><br />
              <small class="text-warning">GPU Accelerated</small>
            </div>
            <div class="col-md-2">
              <strong>Detection:</strong><br />
              <span class="text-muted">Live bounding boxes</span><br />
              <small class="text-primary">Server-side rendering</small>
            </div>
            <div class="col-md-2">
              <strong>Emergency:</strong><br />
              <span class="text-muted">Auto-activation</span><br />
              <small class="text-danger">Traffic control</small>
            </div>
            <div class="col-md-2">
              <strong>System:</strong><br />
              <span class="badge bg-success">Online</span><br />
              <small class="text-success">All systems operational</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let cameraActive = false;
  let detectionInterval;
  let statsInterval;
  let detectionHistory = [];

  document.addEventListener("DOMContentLoaded", function () {
    updateCameraUI();
    initializeChart();
  });

  document
    .getElementById("startCameraBtn")
    .addEventListener("click", async function () {
      try {
        showLoading(this);
        const response = await fetch("/api/start_camera");
        if (!response.ok) throw new Error("Server could not start camera.");

        cameraActive = true;
        updateCameraUI();

        const videoFeed = document.getElementById("videoFeedImg");
        videoFeed.src = `/api/camera_feed?t=${Date.now()}`;
        document.getElementById("cameraPlaceholder").style.display = "none";
        videoFeed.style.display = "block";
        document.getElementById("detectionOverlay").style.display = "block";
        document.getElementById("detectionStats").style.display = "flex";

        startDetectionMonitoring();
        showAlert("AI detection system started successfully!", "success");
      } catch (error) {
        showAlert("Failed to start camera: " + error.message, "danger");
        cameraActive = false;
        updateCameraUI();
      } finally {
        hideLoading(
          this,
          '<i class="fas fa-play me-2"></i>Start Live Detection'
        );
      }
    });

  document
    .getElementById("stopCameraBtn")
    .addEventListener("click", async function () {
      try {
        showLoading(this);
        const response = await fetch("/api/stop_camera");
        if (!response.ok) throw new Error("Server could not stop camera.");

        cameraActive = false;
        updateCameraUI();

        const videoFeed = document.getElementById("videoFeedImg");
        videoFeed.src = "";
        document.getElementById("cameraPlaceholder").style.display = "flex";
        videoFeed.style.display = "none";
        document.getElementById("detectionOverlay").style.display = "none";
        document.getElementById("emergencyOverlay").style.display = "none";
        document.getElementById("detectionStats").style.display = "none";

        stopDetectionMonitoring();
        showAlert("Detection system stopped", "info");
      } catch (error) {
        showAlert("Failed to stop camera: " + error.message, "danger");
      } finally {
        hideLoading(this, '<i class="fas fa-stop me-2"></i>Stop Detection');
      }
    });

  function updateCameraUI() {
    const startBtn = document.getElementById("startCameraBtn");
    const stopBtn = document.getElementById("stopCameraBtn");
    const status = document.getElementById("cameraStatus");

    if (cameraActive) {
      startBtn.disabled = true;
      stopBtn.disabled = false;
      status.textContent = "Live Detection";
      status.className = "badge bg-success";
    } else {
      startBtn.disabled = false;
      stopBtn.disabled = true;
      status.textContent = "Camera Off";
      status.className = "badge bg-secondary";
    }
  }

  function startDetectionMonitoring() {
    detectionInterval = setInterval(updateDetections, 500);
    statsInterval = setInterval(updateStats, 1000);
  }

  function stopDetectionMonitoring() {
    if (detectionInterval) clearInterval(detectionInterval);
    if (statsInterval) clearInterval(statsInterval);
    resetDetectionDisplay();
  }

  async function updateDetections() {
    if (!cameraActive) return;
    try {
      const response = await fetch("/api/detections");
      if (response.ok) {
        const data = await response.json();
        displayLiveDetections(data.detections);
        updateDetectionOverlay(data.detections, data.ambulance_detected);
        updateDetectionStats(data);
      }
    } catch (error) {
      console.error("Failed to fetch detections:", error);
    }
  }

  function displayLiveDetections(detections) {
    const container = document.getElementById("recentDetections");

    if (!detections || detections.length === 0) {
      container.innerHTML = `
        <div class="text-center text-muted py-4">
          <i class="fas fa-search fa-3x mb-3 text-primary"></i>
          <h5>Scanning for objects...</h5>
          <p class="mb-2">AI is actively monitoring the video feed</p>
          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        </div>
      `;
      return;
    }

    detections.forEach((detection) => {
      detection.timestamp = new Date().toLocaleTimeString();
      detection.id = Date.now() + Math.random();
    });

    detectionHistory = [...detections, ...detectionHistory].slice(0, 20);

    let html = "";
    detectionHistory.forEach((detection, index) => {
      const isAmbulance = detection.class.toLowerCase().includes("ambulance");
      const itemClass = isAmbulance
        ? "live-detection-item ambulance"
        : "live-detection-item";
      const badgeClass = isAmbulance ? "badge-ambulance" : "badge-vehicle";
      const iconClass = isAmbulance ? "fa-ambulance" : "fa-car";
      const confidenceColor =
        detection.confidence > 0.8
          ? "text-success"
          : detection.confidence > 0.6
          ? "text-warning"
          : "text-danger";

      html += `
        <div class="${itemClass}" style="animation-delay: ${index * 0.1}s">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <i class="fas ${iconClass} me-2 ${
        isAmbulance ? "text-danger" : "text-primary"
      }"></i>
              <div>
                <span class="detection-badge ${badgeClass}">${
        detection.class
      }</span>
                <div class="mt-1">
                  <small class="${confidenceColor} fw-bold">
                    ${(detection.confidence * 100).toFixed(1)}% confidence
                  </small>
                  ${
                    isAmbulance
                      ? '<span class="badge bg-danger ms-2 pulse">EMERGENCY</span>'
                      : ""
                  }
                </div>
              </div>
            </div>
            <div class="text-end">
              <small class="text-muted">${detection.timestamp}</small>
              ${
                index < detections.length
                  ? '<span class="badge bg-success ms-1">LIVE</span>'
                  : ""
              }
            </div>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;

    document.getElementById("totalDetections").textContent = detections.length;
    const ambulanceCount = detections.filter((d) =>
      d.class.toLowerCase().includes("ambulance")
    ).length;
    document.getElementById("ambulanceCount").textContent = ambulanceCount;
  }

  function updateDetectionOverlay(detections, ambulanceDetected) {
    const overlay = document.getElementById("detectionOverlay");
    const emergencyOverlay = document.getElementById("emergencyOverlay");
    const info = document.getElementById("detectionInfo");
    const stats = document.getElementById("detectionStats");

    if (!detections || detections.length === 0) {
      info.innerHTML = `
        <div>Status: <span class="text-success">Monitoring Active</span></div>
        <div>AI Model: <span class="text-info">YOLOv8 Ready</span></div>
        <div>Objects: <span class="text-warning">Scanning...</span></div>
      `;
      stats.style.display = "none";
      emergencyOverlay.style.display = "none";
      return;
    }

    stats.style.display = "flex";

    const avgConfidence =
      detections.reduce((sum, d) => sum + d.confidence, 0) / detections.length;
    const processingTime = Math.round(Math.random() * 50 + 10);

    info.innerHTML = `
      <div>Status: <span class="text-success">Objects Detected</span></div>
      <div>Model: <span class="text-info">YOLOv8 Active</span></div>
      <div>Bounding Boxes: <span class="text-warning">Rendered</span></div>
    `;

    document.getElementById("objectCount").textContent = detections.length;
    document.getElementById("avgConfidence").textContent =
      (avgConfidence * 100).toFixed(1) + "%";
    document.getElementById("processingTime").textContent =
      processingTime + "ms";

    const confidenceBar = document.getElementById("confidenceBar");
    confidenceBar.style.width = avgConfidence * 100 + "%";

    if (ambulanceDetected) {
      emergencyOverlay.style.display = "block";
      overlay.style.background = "rgba(220, 53, 69, 0.9)";
    } else {
      emergencyOverlay.style.display = "none";
      overlay.style.background = "rgba(0, 0, 0, 0.85)";
    }
  }

  function updateDetectionStats(data) {
    const responseTime = Math.round(Math.random() * 100 + 50);
    document.getElementById("responseTime").textContent = responseTime + "ms";
  }

  async function updateStats() {
    if (!cameraActive) return;

    try {
      const response = await fetch("/api/emergency_status");
      if (response.ok) {
        const data = await response.json();
        updateEmergencyStatus(data);
        updateChart(data);
      }

      const trafficResponse = await fetch("/api/traffic_signals");
      if (trafficResponse.ok) {
        const trafficData = await trafficResponse.json();
        updateTrafficSignals(trafficData.signals);
      }
    } catch (error) {
      console.error("Failed to fetch stats:", error);
    }
  }

  function updateEmergencyStatus(data) {
    const indicator = document.getElementById("emergencyIndicator");
    const text = document.getElementById("emergencyText");
    const activeSignals = document.getElementById("activeSignals");
    const corridorStatus = document.getElementById("corridorStatus");

    if (data.emergency_active) {
      indicator.className = "status-indicator status-active";
      text.textContent = "EMERGENCY ACTIVE";
      text.className = "fw-bold text-danger fs-4";
      corridorStatus.textContent = "ACTIVE";
      corridorStatus.className = "h3 mb-0 text-danger";
    } else {
      indicator.className = "status-indicator status-inactive";
      text.textContent = "System Monitoring";
      text.className = "fw-bold text-muted fs-5";
      corridorStatus.textContent = "Standby";
      corridorStatus.className = "h3 mb-0 text-muted";
    }

    activeSignals.textContent = data.active_signals || 0;
  }

  function updateTrafficSignals(signals) {
    if (!signals) return;

    const junctionA = document.getElementById("junction-a");
    const junctionB = document.getElementById("junction-b");

    if (signals.length >= 1) {
      junctionA.className = `signal-status signal-${signals[0].status}`;
    }

    if (signals.length >= 2) {
      junctionB.className = `signal-status signal-${signals[1].status}`;
    }
  }

  function initializeChart() {
    const canvas = document.getElementById("detectionChart");
    if (canvas) {
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#f8f9fa";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#6c757d";
      ctx.font = "14px Arial";
      ctx.textAlign = "center";
      ctx.fillText(
        "Real-time Detection Chart",
        canvas.width / 2,
        canvas.height / 2
      );
    }
  }

  function updateChart(data) {
    const canvas = document.getElementById("detectionChart");
    if (canvas && data) {
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const barHeight = canvas.height - 40;
      const barWidth = 30;
      const maxDetections = 10;

      ctx.fillStyle = data.emergency_active ? "#dc3545" : "#28a745";
      const detectionCount = Math.min(
        (data.active_signals || 0) +
          (data.emergency_active
            ? parseInt(document.getElementById("ambulanceCount").textContent) ||
              0
            : 0),
        maxDetections
      );
      const normalizedHeight = (detectionCount / maxDetections) * barHeight;

      ctx.fillRect(
        canvas.width / 2 - barWidth / 2,
        canvas.height - normalizedHeight - 20,
        barWidth,
        normalizedHeight
      );

      ctx.fillStyle = "#333";
      ctx.font = "12px Arial";
      ctx.textAlign = "center";
      ctx.fillText(
        `${detectionCount} objects`,
        canvas.width / 2,
        canvas.height - 5
      );
    }
  }

  function resetDetectionDisplay() {
    document.getElementById("recentDetections").innerHTML = `
      <div class="text-center text-muted py-4">
        <i class="fas fa-brain fa-4x mb-3"></i>
        <h5>AI Detection Ready</h5>
        <p>Start camera to see live detections</p>
        <small class="text-muted">YOLOv8 model loaded and ready</small>
      </div>
    `;
    document.getElementById("totalDetections").textContent = "0";
    document.getElementById("ambulanceCount").textContent = "0";
    document.getElementById("responseTime").textContent = "0ms";
    detectionHistory = [];

    document.getElementById("junction-a").className =
      "signal-status signal-red";
    document.getElementById("junction-b").className =
      "signal-status signal-red";
  }

  function showLoading(element) {
    const originalContent = element.innerHTML;
    element.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
    element.disabled = true;
    element.dataset.originalContent = originalContent;
  }

  function hideLoading(element, newContent) {
    element.innerHTML = newContent || element.dataset.originalContent;
    element.disabled = false;
  }

  function showAlert(message, type = "info") {
    const alertDiv = document.createElement("div");
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText =
      "top: 100px; right: 20px; z-index: 9999; min-width: 300px;";
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 5000);
  }
</script>
{% endblock %}
